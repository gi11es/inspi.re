var marquee_bottom_style = $("marquee_bottom").style;var marquee_right_style = $("marquee_right").style;var corner_top_left_style = $("corner_top_left").style;var corner_bottom_left_style = $("corner_bottom_left").style;var corner_bottom_right_style = $("corner_bottom_right").style;var corner_top_right_style = $("corner_top_right").style;var cropped_style = $("picture_huge_cropped").style;cropped_style.backgroundImage = "url('" + $('picture_huge').readAttribute("src") + "')";var picture_width = $("var_total_width").getValue();var picture_height = $("var_total_height").getValue();var minimum_size = 40;var CropDraggable = Class.create();Object.extend( Object.extend( CropDraggable.prototype, Draggable.prototype), {		updateDrag: function(event, pointer) {    if(!this.dragging) this.startDrag(event);        if(!this.options.quiet){      Position.prepare();      Droppables.show(pointer, this.element);    }        //Draggables.notify('onDrag', this, event);        this.draw(pointer);    if(this.options.change) this.options.change(this);        if(this.options.scroll) {      this.stopScrolling();            var p;      if (this.options.scroll == window) {        with(this._getWindowScroll(this.options.scroll)) { p = [ left, top, left+width, top+height ]; }      } else {        p = Position.page(this.options.scroll);        p[0] += this.options.scroll.scrollLeft + Position.deltaX;        p[1] += this.options.scroll.scrollTop + Position.deltaY;        p.push(p[0]+this.options.scroll.offsetWidth);        p.push(p[1]+this.options.scroll.offsetHeight);      }      var speed = [0,0];      if(pointer[0] < (p[0]+this.options.scrollSensitivity)) speed[0] = pointer[0]-(p[0]+this.options.scrollSensitivity);      if(pointer[1] < (p[1]+this.options.scrollSensitivity)) speed[1] = pointer[1]-(p[1]+this.options.scrollSensitivity);      if(pointer[0] > (p[2]-this.options.scrollSensitivity)) speed[0] = pointer[0]-(p[2]-this.options.scrollSensitivity);      if(pointer[1] > (p[3]-this.options.scrollSensitivity)) speed[1] = pointer[1]-(p[3]-this.options.scrollSensitivity);      this.startScrolling(speed);    }        // fix AppleWebKit rendering    if(Prototype.Browser.WebKit) window.scrollBy(0,0);        Draggables.notify('onDrag', this, event);        Event.stop(event);  }	});new CropDraggable("picture_huge_cropped", {scroll: window, starteffect: null, endeffect: null, onDrag: matchMove});new CropDraggable("corner_top_left", {scroll: window, starteffect: null, endeffect: null, zindex: 1500, onDrag: matchResizeTopLeft});new CropDraggable("corner_top_right", {scroll: window, starteffect: null, endeffect: null, zindex: 1500, onDrag: matchResizeTopRight});new CropDraggable("corner_bottom_left", {scroll: window, starteffect: null, endeffect: null, zindex: 1500, onDrag: matchResizeBottomLeft});new CropDraggable("corner_bottom_right", {scroll: window, starteffect: null, endeffect: null, zindex: 1500, onDrag: matchResizeBottomRight});function matchMove() {	var crop_width = $("picture_huge_cropped").getWidth();	var crop_height = $("picture_huge_cropped").getHeight();	var crop_left_px = cropped_style.left;	var crop_left = parseInt(crop_left_px.substr(0, crop_left_px.length - 2));	if (crop_left < 0) {		cropped_style.left = "0px";	} else if (crop_left > picture_width - crop_width) {		cropped_style.left = picture_width - crop_width + "px";	}		var crop_top_px = cropped_style.top;	var crop_top = parseInt(crop_top_px.substr(0, crop_top_px.length - 2));	if (crop_top < 0) {		cropped_style.top = "0px";	} else if (crop_top > picture_height - crop_height) {		cropped_style.top = picture_height - crop_height + "px";	}		matchBackground();	matchMarquees(crop_width, crop_height);	matchCorners(crop_width, crop_height);}function matchBackground() {	cropped_style.backgroundPosition = "-" + cropped_style.left + " -" + cropped_style.top;}function matchMarquees(crop_width, crop_height) {	marquee_bottom_style.top = crop_height - 2 + "px";	marquee_right_style.left = crop_width - 1 + "px";}function matchCorners(crop_width, crop_height) {	var corner_left = crop_width - 5 + "px";	var corner_top = crop_height - 4 + "px";		corner_bottom_left_style.top = corner_top;	corner_top_right_style.left = corner_left;	corner_bottom_right_style.top = corner_top;	corner_bottom_right_style.left = corner_left;}function matchResizeTopLeft() {	var crop_width = $("picture_huge_cropped").getWidth();	var crop_height = $("picture_huge_cropped").getHeight();	var crop_top = cropped_style.top;	crop_top = parseInt(crop_top.substr(0, crop_top.length - 2));	var crop_left = cropped_style.left;	crop_left = parseInt(crop_left.substr(0, crop_left.length - 2));		var corner_top_left_left_px = corner_top_left_style.left;	var corner_top_left_left = parseInt(corner_top_left_left_px.substr(0, corner_top_left_left_px.length - 2));	var corner_top_left_top_px = corner_top_left_style.top;	var corner_top_left_top = parseInt(corner_top_left_top_px.substr(0, corner_top_left_top_px.length - 2));		if (crop_left + corner_top_left_left + 3 < 0) {		corner_top_left_left = - crop_left - 3;		corner_top_left_style.left = corner_top_left_left + "px";		corner_top_left_top = corner_top_left_left;	}		if (crop_top + corner_top_left_top + 3 < 0) {		corner_top_left_top = - crop_top - 3;		corner_top_left_style.top = corner_top_left_top + "px";		corner_top_left_left = corner_top_left_top;	}		if (corner_top_left_left > corner_top_left_top) {		corner_top_left_left = corner_top_left_top;		corner_top_left_style.left = corner_top_left_left + "px";	} else if (corner_top_left_left < corner_top_left_top) {		corner_top_left_top = corner_top_left_left;		corner_top_left_style.top = corner_top_left_top + "px";	}		if (crop_width - corner_top_left_top - 3 < minimum_size) {		corner_top_left_top = - minimum_size - 3 + crop_width;		corner_top_left_style.top = corner_top_left_top + "px";		corner_top_left_left = corner_top_left_top;		corner_top_left_style.left = corner_top_left_style.top;	}		cropped_style.top = crop_top + corner_top_left_top + 3 + "px";	cropped_style.left = crop_left + corner_top_left_left + 3 + "px";	cropped_style.width = crop_width - corner_top_left_top - 3 + "px";	cropped_style.height = crop_height - corner_top_left_top - 3 + "px";	corner_top_left_style.left = "-3px";	corner_top_left_style.top = "-3px";		var crop_width = $("picture_huge_cropped").getWidth();	var crop_height = $("picture_huge_cropped").getHeight();		matchMove();}function matchResizeTopRight() {	var crop_width = $("picture_huge_cropped").getWidth();	var crop_height = $("picture_huge_cropped").getHeight();	var crop_top = cropped_style.top;	crop_top = parseInt(crop_top.substr(0, crop_top.length - 2));	var crop_left = cropped_style.left;	crop_left = parseInt(crop_left.substr(0, crop_left.length - 2));		var corner_top_right_left_px = corner_top_right_style.left;	var corner_top_right_left = parseInt(corner_top_right_left_px.substr(0, corner_top_right_left_px.length - 2));	var corner_top_right_top_px = corner_top_right_style.top;	var corner_top_right_top = parseInt(corner_top_right_top_px.substr(0, corner_top_right_top_px.length - 2));		if (crop_left + corner_top_right_left + 5 > picture_width) {		corner_top_right_left = picture_width - crop_left - 5;		corner_top_right_style.left = corner_top_right_left + "px";		corner_top_right_top = - corner_top_right_left + crop_width - 8;	}		if (crop_top + corner_top_right_top + 3 < 0) {		corner_top_right_top = - crop_top - 3;		corner_top_right_style.top = corner_top_right_top + "px";		corner_top_right_left = - corner_top_right_top + crop_width - 8;	} 		if (- corner_top_right_left + crop_width > corner_top_right_top + 8) {		corner_top_right_left = - corner_top_right_top + crop_width - 8;		corner_top_right_style.left = corner_top_right_left + "px";	} else if (- corner_top_right_left + crop_width < corner_top_right_top + 8) {		corner_top_right_top = - corner_top_right_left + crop_width - 8;		corner_top_right_style.top = corner_top_right_top + "px";	}		if (corner_top_right_left + 5 < minimum_size) {		corner_top_right_top = - minimum_size + crop_height - 3;		corner_top_right_style.top = corner_top_right_top + "px";				corner_top_right_left = - corner_top_right_top + crop_width - 8;		corner_top_right_style.left = corner_top_right_left + "px";	}		cropped_style.top = crop_top + corner_top_right_top + 3 + "px";	cropped_style.width = corner_top_right_left + 5 + "px";	cropped_style.height = crop_height - corner_top_right_top - 3 + "px";		var crop_width = $("picture_huge_cropped").getWidth();	var crop_height = $("picture_huge_cropped").getHeight();		corner_top_right_style.left = crop_width - 5 + "px";	corner_top_right_style.top = "-3px"; 		matchMove();}function matchResizeBottomLeft() {	var crop_width = $("picture_huge_cropped").getWidth();	var crop_height = $("picture_huge_cropped").getHeight();	var crop_top = cropped_style.top;	crop_top = parseInt(crop_top.substr(0, crop_top.length - 2));	var crop_left = cropped_style.left;	crop_left = parseInt(crop_left.substr(0, crop_left.length - 2));		var corner_bottom_left_left_px = corner_bottom_left_style.left;	var corner_bottom_left_left = parseInt(corner_bottom_left_left_px.substr(0, corner_bottom_left_left_px.length - 2));	var corner_bottom_left_top_px = corner_bottom_left_style.top;	var corner_bottom_left_top = parseInt(corner_bottom_left_top_px.substr(0, corner_bottom_left_top_px.length - 2));		if (crop_left + corner_bottom_left_left + 3 < 0) {		corner_bottom_left_left = - crop_left - 3;		corner_bottom_left_style.left = corner_bottom_left_left + "px";		corner_bottom_left_top = - corner_bottom_left_left + crop_height - 7;		corner_bottom_left_style.top = corner_bottom_left_top + "px";	}		if (crop_top + corner_bottom_left_top + 4  > picture_height) {		corner_bottom_left_top = picture_height - crop_top - 4;		corner_bottom_left_style.top = corner_bottom_left_top + "px";		corner_bottom_left_left = crop_height - corner_bottom_left_top - 7;		corner_bottom_left_style.left = corner_bottom_left_left + "px";	}		if (corner_bottom_left_left < - corner_bottom_left_top + crop_height - 7) {		corner_bottom_left_top = - corner_bottom_left_left + crop_height - 7;		corner_bottom_left_style.top = corner_bottom_left_top + "px";	} else if (corner_bottom_left_left > - corner_bottom_left_top + crop_height - 7) {		corner_bottom_left_left = crop_height - corner_bottom_left_top - 7;		corner_bottom_left_style.left = corner_bottom_left_left + "px";	}		if (crop_width - corner_bottom_left_left - 3 < minimum_size) {		corner_bottom_left_top = minimum_size - 4;		corner_bottom_left_style.top = corner_bottom_left_top + "px";				corner_bottom_left_left = crop_width + 3 - minimum_size;		corner_bottom_left_style.left = corner_bottom_left_left + "px";	}		cropped_style.left = crop_left + corner_bottom_left_left + 3 + "px";	cropped_style.width = crop_width - corner_bottom_left_left - 3 + "px";	cropped_style.height = corner_bottom_left_top + 4 + "px";		var crop_width = $("picture_huge_cropped").getWidth();	var crop_height = $("picture_huge_cropped").getHeight();		corner_bottom_left_style.left = "-3px";	corner_bottom_left_style.top = crop_height - 4 + "px"; 		matchMove();}function matchResizeBottomRight() {	var crop_width = $("picture_huge_cropped").getWidth();	var crop_height = $("picture_huge_cropped").getHeight();	var crop_top = cropped_style.top;	crop_top = parseInt(crop_top.substr(0, crop_top.length - 2));	var crop_left = cropped_style.left;	crop_left = parseInt(crop_left.substr(0, crop_left.length - 2));		var corner_bottom_right_left_px = corner_bottom_right_style.left;	var corner_bottom_right_left = parseInt(corner_bottom_right_left_px.substr(0, corner_bottom_right_left_px.length - 2));	var corner_bottom_right_top_px = corner_bottom_right_style.top;	var corner_bottom_right_top = parseInt(corner_bottom_right_top_px.substr(0, corner_bottom_right_top_px.length - 2));		if (crop_left + corner_bottom_right_left + 5 > picture_width) {		corner_bottom_right_left = picture_width - crop_left - 5;		corner_bottom_right_style.left = corner_bottom_right_left + "px";		corner_bottom_right_top = corner_bottom_right_left + 1;		corner_bottom_right_style.top = corner_bottom_right_top + "px";	}		if (crop_top + corner_bottom_right_top + 4  > picture_height) {		corner_bottom_right_top = picture_height - crop_top - 4;		corner_bottom_right_style.top = corner_bottom_right_top + "px";		corner_bottom_right_left = corner_bottom_right_top - 1;		corner_bottom_right_style.left = corner_bottom_right_left + "px";	}		if (corner_bottom_right_left+ 1 > corner_bottom_right_top) {		corner_bottom_right_top = corner_bottom_right_left + 1;		corner_bottom_right_style.top = corner_bottom_right_top + "px";	} else if (corner_bottom_right_left + 1 < corner_bottom_right_top) {		corner_bottom_right_left = corner_bottom_right_top - 1;		corner_bottom_right_style.left = corner_bottom_right_left + "px";	}		if (corner_bottom_right_left + 5 < minimum_size) {		corner_bottom_right_left = minimum_size - 5;		corner_bottom_right_style.left = corner_bottom_right_left + "px";				corner_bottom_right_top = minimum_size - 4;		corner_bottom_right_style.top = corner_bottom_right_top + "px";	}		cropped_style.width = corner_bottom_right_left + 5 + "px";	cropped_style.height = corner_bottom_right_top + 4 + "px";		var crop_width = $("picture_huge_cropped").getWidth();	var crop_height = $("picture_huge_cropped").getHeight();		corner_bottom_right_style.left = crop_width - 5 + "px";	corner_bottom_right_style.top = crop_height - 4 + "px"; 		matchMove();}function saveCrop() {	var crop_width = $("picture_huge_cropped").getWidth();	var crop_height = $("picture_huge_cropped").getHeight();	var crop_top = cropped_style.top;	crop_top = parseInt(crop_top.substr(0, crop_top.length - 2));	var crop_left = cropped_style.left;	crop_left = parseInt(crop_left.substr(0, crop_left.length - 2));		new Ajax.Request($("var_request_update_cropping").getValue(), {                parameters: {                        left: crop_left,                        top: crop_top,                        width: crop_width,                        height: crop_height                },                onSuccess: function(transport) {                 	$("cropping").submit();                }        });}